pipeline {
    agent any

    ennvironment {
        NODE_VERSION = '25.2.1'
        SERVICE_ID = 'render-service-id'
        RENDER_API_KEY = 'render-api-key'
    }

    tools {
        nodejs "${NODE_VERSION}"
    }

    stages {
        stage("Checkout") {
            steps {
                checkout scm
            }
        }

        stage("Install Dependencies") {
            steps {
                bat "npm install"
                bat "npm install -g wait-on kill-port"
            }
        }

        stage("Run tests") {
            steps {
                bat "start /b npm run start"
                bat "wait-on http://localhost:8081"
                bat "npm test"
                bat "kill-port 8081"
            }
        }
    }

    post {
        always {
            echo "CI pipeline completed"
        }
        failure {
            echo "kill-port 8081"
        }
    }
}
